# A* Routing Visualizer â€” Design Document

## Overview

A TypeScript browser application that parses OSM map files, renders them on an interactive map, and visualizes A* pathfinding with animated route exploration. Supports car, bicycle, and pedestrian routing modes.

## Technology Stack

- **Vite + TypeScript** â€” build tooling and type safety
- **Leaflet** â€” map rendering (tiles + custom overlays)
- **Vanilla TypeScript** â€” no framework, direct DOM control
- **CSS custom properties** â€” dark/light theme switching

## Project Structure

```
src/
  main.ts              # Entry point
  ui/
    settings-panel.ts  # Floating, draggable settings box
    theme.ts           # Dark/light theme management
    file-browser.ts    # OSM file scanner/selector
  map/
    map-view.ts        # Leaflet map setup, tile layer toggle
    map-renderer.ts    # Drawing routes, explored edges
  osm/
    parser.ts          # Parse OSM XML â†’ graph structure
    graph.ts           # Node/Edge types, adjacency list
  routing/
    a-star.ts          # A* implementation (generator-based)
    map-matching.ts    # Snap clicks to nearest valid road segment
    road-types.ts      # Speed profiles per mode, road access rules
  animation/
    animator.ts        # Steps through A* states, draws on map
```

## Graph Model

### Types

```typescript
interface GraphNode {
  id: number;       // OSM node ID
  lat: number;
  lon: number;
}

interface GraphEdge {
  from: number;           // node ID
  to: number;             // node ID
  wayId: number;          // OSM way ID
  highway: string;        // road type
  maxspeed: number;       // km/h
  oneway: boolean;        // for cars
  onewayBicycle: boolean; // oneway:bicycle=no override
  distance: number;       // meters (Haversine)
  geometry: [number, number][]; // lat/lon pairs for rendering
}
```

### Road Access Rules

| Highway type | Car | Bicycle | Pedestrian |
|---|---|---|---|
| motorway, trunk | âœ… | âŒ | âŒ |
| primary, secondary, tertiary | âœ… | âœ… | âœ… |
| residential, unclassified, service | âœ… | âœ… | âœ… |
| cycleway | âŒ | âœ… | âœ… |
| footway, pedestrian, path, steps | âŒ | âŒ | âœ… |
| busway | âŒ | âŒ | âŒ |

### Default Speeds (cars, when no maxspeed tag)

- primary: 50 km/h
- secondary: 50 km/h
- tertiary: 30 km/h
- residential: 30 km/h
- service: 15 km/h
- unclassified: 30 km/h

### Turn Restrictions

Parsed from `<relation>` elements with `type=restriction`. Stored as `Map<"fromWay-viaNode", Set<toWay>>`. Applied only for car routing.

### Oneway Handling

- Cars: respect `oneway=yes`
- Bicycles: ignore oneway if `oneway:bicycle=no`
- Pedestrians: ignore all oneways

## A* Routing Engine

### Generator-based implementation

```typescript
function* aStarRoute(graph, start, end, mode): Generator<AStarStep>
```

Each yield returns: `{ type: 'explore', edge, fScore }` or `{ type: 'done', path: Edge[] }`.

### Cost function

Travel time = `edge.distance / speed`:
- Cars: speed from maxspeed tag or default per highway type
- Bicycles: always 20 km/h
- Pedestrians: always 5 km/h

### Heuristic

Haversine distance to destination / max possible speed for mode (admissible).

### Turn restriction enforcement (cars only)

When expanding a node, check if from-wayId â†’ via-node â†’ to-wayId is a forbidden turn.

## Animation System

1. Run A* to completion first (instant), collecting all exploration steps + final path
2. Replay steps visually using `requestAnimationFrame`
3. Speed slider 1â€“10: Speed 1 = ~200ms/step, Speed 10 = batch multiple steps per frame
4. Blue lines = explored edges (growing Leaflet polyline layer)
5. Red line = final path edges, highlighted when the replay reaches them
6. Red layer sits on top via Leaflet pane ordering

## Map Rendering

- **Tile layer:** OpenStreetMap tiles, togglable, 50% opacity default
- **Road rendering:** All parsed roads as thin gray polylines
- **Pane z-order:** roads (gray) â†’ explored (blue) â†’ route (red) â†’ markers
- **Markers:** Green circle (origin), red circle (destination)

## Map Matching

- On click: find nearest point on valid road segment for current mode
- Perpendicular projection onto edge geometry, clamped to segment endpoints
- Re-snap when switching routing modes

## UI: Floating Settings Panel

- Semi-transparent rounded card, top-right corner
- Draggable via header mousedown â†’ mousemove tracking
- Contents:
  1. Map file selector (dropdown from `/maps/index.json`)
  2. Routing mode: ğŸš— Car | ğŸš² Bicycle | ğŸš¶ Pedestrian
  3. Animation speed slider (1â€“10)
  4. Background tiles toggle (on by default)
  5. Theme toggle: â˜€ï¸ Light | ğŸŒ™ Dark

## File Browser

Vite serves `/maps/index.json` listing available `.osm` files. Generated by a build script that scans `public/maps/`.

## Theme System

CSS custom properties on `:root`, switched by `data-theme="dark|light"` attribute. Affects panel, road palette, and markers.
